# UmaSimCraft ë°°í¬ ë° ìš´ì˜ ê°€ì´ë“œ

## 1. ë°°í¬ í™˜ê²½ êµ¬ì„±

### 1.1 ê°œë°œ í™˜ê²½
- **ë¡œì»¬ ê°œë°œ**: Docker Compose
- **ìŠ¤í…Œì´ì§•**: í´ë¼ìš°ë“œ ì„œë²„ (í…ŒìŠ¤íŠ¸ìš©)
- **í”„ë¡œë•ì…˜**: í´ë¼ìš°ë“œ ì„œë²„ (ìš´ì˜ìš©)

### 1.2 ì¸í”„ë¼ ìš”êµ¬ì‚¬í•­
| êµ¬ì„± ìš”ì†Œ | ìµœì†Œ ì‚¬ì–‘ | ê¶Œì¥ ì‚¬ì–‘ |
|-----------|-----------|-----------|
| CPU | 2ì½”ì–´ | 4ì½”ì–´ |
| ë©”ëª¨ë¦¬ | 4GB | 8GB |
| ì €ì¥ê³µê°„ | 20GB | 50GB |
| ë„¤íŠ¸ì›Œí¬ | 100Mbps | 1Gbps |

## 2. Docker ë°°í¬

### 2.1 Docker Compose ì„¤ì •
```yaml
# docker-compose.yml
version: '3.9'

services:
  web:
    build: .
    command: uvicorn project.asgi:application --host 0.0.0.0 --port 8000 --workers 4
    env_file: .env
    volumes:
      - ./static:/app/static
      - ./media:/app/media
    depends_on:
      - db
      - redis
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3

  db:
    image: mariadb:11
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
      - ./scripts/init.sql:/docker-entrypoint-initdb.d/1.sql
    ports:
      - "3306:3306"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./static:/var/www/static
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - web
    restart: unless-stopped

volumes:
  db_data:
  redis_data:
```

### 2.2 Dockerfile
```dockerfile
# Dockerfile
FROM python:3.13-slim as builder

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# í”„ë¡œë•ì…˜ ì´ë¯¸ì§€
FROM python:3.13-slim

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ì‚¬ìš©ì ìƒì„±
RUN useradd --create-home --shell /bin/bash app

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Python íŒ¨í‚¤ì§€ ë³µì‚¬
COPY --from=builder /usr/local/lib/python3.13/site-packages /usr/local/lib/python3.13/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ì •ì  íŒŒì¼ ìˆ˜ì§‘
RUN python manage.py collectstatic --noinput

# ê¶Œí•œ ì„¤ì •
RUN chown -R app:app /app
USER app

# í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health/ || exit 1

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# ì‹¤í–‰ ëª…ë ¹
CMD ["uvicorn", "project.asgi:application", "--host", "0.0.0.0", "--port", "8000"]
```

### 2.3 í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
```bash
# .env
# Django ì„¤ì •
DEBUG=False
SECRET_KEY=your-secret-key-here
ALLOWED_HOSTS=localhost,127.0.0.1,your-domain.com

# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
DB_NAME=uma
DB_USER=uma
DB_PASSWORD=uma_password
DB_ROOT_PASSWORD=root_password
DB_HOST=db
DB_PORT=3306

# Redis ì„¤ì •
REDIS_HOST=redis
REDIS_PORT=6379

# ì´ë©”ì¼ ì„¤ì •
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@gmail.com
EMAIL_HOST_PASSWORD=your-app-password

# ëª¨ë‹ˆí„°ë§ ì„¤ì •
SENTRY_DSN=your-sentry-dsn
PROMETHEUS_ENABLED=True
```

## 3. Nginx ì„¤ì •

### 3.1 Nginx ì„¤ì • íŒŒì¼
```nginx
# nginx.conf
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ë¡œê·¸ í˜•ì‹
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    # Gzip ì••ì¶•
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # ì—…ìŠ¤íŠ¸ë¦¼ ì„œë²„
    upstream django {
        server web:8000;
    }

    # HTTP ì„œë²„
    server {
        listen 80;
        server_name localhost;

        # ì •ì  íŒŒì¼
        location /static/ {
            alias /var/www/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # ë¯¸ë””ì–´ íŒŒì¼
        location /media/ {
            alias /app/media/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Django ì• í”Œë¦¬ì¼€ì´ì…˜
        location / {
            proxy_pass http://django;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
        }

        # WebSocket ì§€ì›
        location /ws/ {
            proxy_pass http://django;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # í—¬ìŠ¤ì²´í¬
        location /health/ {
            proxy_pass http://django;
            access_log off;
        }
    }
}
```

## 4. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸

### 4.1 ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# deploy.sh

set -e

echo "ğŸš€ UmaSimCraft ë°°í¬ ì‹œì‘..."

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
source .env

# Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
echo "ğŸ“¥ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°..."
git pull origin main

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
echo "ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ..."
docker-compose build

# ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜..."
docker-compose exec -T web python manage.py migrate

# ì •ì  íŒŒì¼ ìˆ˜ì§‘
echo "ğŸ“ ì •ì  íŒŒì¼ ìˆ˜ì§‘..."
docker-compose exec -T web python manage.py collectstatic --noinput

# Tailwind CSS ë¹Œë“œ
echo "ğŸ¨ Tailwind CSS ë¹Œë“œ..."
docker-compose exec -T web python manage.py tailwind build --minify

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
echo "ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘..."
docker-compose up -d

# í—¬ìŠ¤ì²´í¬
echo "ğŸ¥ í—¬ìŠ¤ì²´í¬..."
sleep 10
if curl -f http://localhost/health/; then
    echo "âœ… ë°°í¬ ì„±ê³µ!"
else
    echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
    exit 1
fi

echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
```

### 4.2 ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# rollback.sh

set -e

echo "ğŸ”„ ë¡¤ë°± ì‹œì‘..."

# ì´ì „ ë²„ì „ìœ¼ë¡œ ì²´í¬ì•„ì›ƒ
git checkout HEAD~1

# Docker ì´ë¯¸ì§€ ë¹Œë“œ
docker-compose build

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker-compose up -d

# í—¬ìŠ¤ì²´í¬
sleep 10
if curl -f http://localhost/health/; then
    echo "âœ… ë¡¤ë°± ì„±ê³µ!"
else
    echo "âŒ ë¡¤ë°± ì‹¤íŒ¨!"
    exit 1
fi

echo "ğŸ‰ ë¡¤ë°± ì™„ë£Œ!"
```

## 5. ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹…

### 5.1 Prometheus ì„¤ì •
```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'django'
    static_configs:
      - targets: ['web:8000']
    metrics_path: '/metrics/'
    scrape_interval: 5s

  - job_name: 'nginx'
    static_configs:
      - targets: ['nginx:80']
    metrics_path: '/nginx_status'
    scrape_interval: 10s

  - job_name: 'mysql'
    static_configs:
      - targets: ['db:3306']
    scrape_interval: 30s

  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']
    scrape_interval: 30s
```

### 5.2 Grafana ëŒ€ì‹œë³´ë“œ
```json
{
  "dashboard": {
    "title": "UmaSimCraft ëª¨ë‹ˆí„°ë§",
    "panels": [
      {
        "title": "HTTP ìš”ì²­ ìˆ˜",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ]
      },
      {
        "title": "ì‘ë‹µ ì‹œê°„",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "p95 ì‘ë‹µ ì‹œê°„"
          }
        ]
      },
      {
        "title": "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°",
        "type": "stat",
        "targets": [
          {
            "expr": "mysql_global_status_threads_connected",
            "legendFormat": "í™œì„± ì—°ê²°"
          }
        ]
      },
      {
        "title": "Redis ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰",
        "type": "graph",
        "targets": [
          {
            "expr": "redis_memory_used_bytes",
            "legendFormat": "ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰"
          }
        ]
      }
    ]
  }
}
```

### 5.3 ë¡œê¹… ì„¤ì •
```python
# settings.py
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'simple': {
            'format': '{levelname} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': 'logs/umasimcraft.log',
            'formatter': 'verbose',
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': 'simple',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['file', 'console'],
            'level': 'INFO',
            'propagate': True,
        },
        'simulator': {
            'handlers': ['file', 'console'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
}
```

## 6. ë°±ì—… ë° ë³µêµ¬

### 6.1 ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…
```bash
#!/bin/bash
# backup_db.sh

set -e

# ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
BACKUP_DIR="/backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR

echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—… ì‹œì‘..."

# MariaDB ë°±ì—…
docker-compose exec -T db mysqldump \
    -u root -p${DB_ROOT_PASSWORD} \
    --single-transaction \
    --routines \
    --triggers \
    uma > $BACKUP_DIR/database.sql

# ì •ì  íŒŒì¼ ë°±ì—…
tar -czf $BACKUP_DIR/static_files.tar.gz static/

# Redis ë°±ì—…
docker-compose exec -T redis redis-cli BGSAVE
sleep 5
docker cp $(docker-compose ps -q redis):/data/dump.rdb $BACKUP_DIR/redis_dump.rdb

echo "âœ… ë°±ì—… ì™„ë£Œ: $BACKUP_DIR"
```

### 6.2 ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# restore.sh

set -e

BACKUP_DIR=$1

if [ -z "$BACKUP_DIR" ]; then
    echo "ì‚¬ìš©ë²•: $0 <ë°±ì—…_ë””ë ‰í† ë¦¬>"
    exit 1
fi

echo "ğŸ”„ ë³µêµ¬ ì‹œì‘: $BACKUP_DIR"

# ì„œë¹„ìŠ¤ ì¤‘ì§€
docker-compose down

# ë°ì´í„°ë² ì´ìŠ¤ ë³µêµ¬
docker-compose up -d db
sleep 10
docker-compose exec -T db mysql -u root -p${DB_ROOT_PASSWORD} uma < $BACKUP_DIR/database.sql

# ì •ì  íŒŒì¼ ë³µêµ¬
tar -xzf $BACKUP_DIR/static_files.tar.gz

# Redis ë³µêµ¬
docker-compose up -d redis
sleep 5
docker cp $BACKUP_DIR/redis_dump.rdb $(docker-compose ps -q redis):/data/dump.rdb
docker-compose exec -T redis redis-cli BGREWRITEAOF

# ì„œë¹„ìŠ¤ ì¬ì‹œì‘
docker-compose up -d

echo "âœ… ë³µêµ¬ ì™„ë£Œ!"
```

## 7. ë³´ì•ˆ ì„¤ì •

### 7.1 ë³´ì•ˆ í—¤ë”
```python
# settings.py
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_REFERRER_POLICY = "strict-origin"
SECURE_CROSS_ORIGIN_OPENER_POLICY = "same-origin"
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# HTTPS ê°•ì œ
SECURE_SSL_REDIRECT = True
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
```

### 7.2 ë°©í™”ë²½ ì„¤ì •
```bash
# UFW ë°©í™”ë²½ ì„¤ì •
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw enable
```

### 7.3 SSL ì¸ì¦ì„œ ì„¤ì •
```nginx
# nginx-ssl.conf
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/ssl/certs/your-domain.crt;
    ssl_certificate_key /etc/ssl/private/your-domain.key;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=63072000" always;

    # ê¸°íƒ€ ì„¤ì •...
}
```

## 8. ì„±ëŠ¥ íŠœë‹

### 8.1 Django ì„¤ì • ìµœì í™”
```python
# settings.py
# ìºì‹± ì„¤ì •
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://redis:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        },
        'TIMEOUT': 3600,
    }
}

# ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': DB_NAME,
        'USER': DB_USER,
        'PASSWORD': DB_PASSWORD,
        'HOST': DB_HOST,
        'PORT': DB_PORT,
        'OPTIONS': {
            'charset': 'utf8mb4',
            'init_command': "SET sql_mode='STRICT_TRANS_TABLES'",
        },
        'CONN_MAX_AGE': 600,
    }
}
```

### 8.2 MariaDB íŠœë‹
```sql
-- my.cnf ì„¤ì •
[mysqld]
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT
query_cache_size = 128M
query_cache_type = 1
max_connections = 200
```

## 9. ì¥ì•  ëŒ€ì‘

### 9.1 ì¥ì•  ê°ì§€ ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# health_check.sh

# í—¬ìŠ¤ì²´í¬ URL
HEALTH_URL="http://localhost/health/"

# ì‘ë‹µ ì‹œê°„ ì„ê³„ê°’ (ì´ˆ)
TIMEOUT=5

# í—¬ìŠ¤ì²´í¬ ì‹¤í–‰
response=$(curl -s -o /dev/null -w "%{http_code}" --max-time $TIMEOUT $HEALTH_URL)

if [ $response -eq 200 ]; then
    echo "âœ… ì„œë¹„ìŠ¤ ì •ìƒ"
    exit 0
else
    echo "âŒ ì„œë¹„ìŠ¤ ì¥ì•  (HTTP $response)"
    
    # ì•Œë¦¼ ë°œì†¡
    curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"UmaSimCraft ì„œë¹„ìŠ¤ ì¥ì•  ë°œìƒ!"}' \
        $SLACK_WEBHOOK_URL
    
    exit 1
fi
```

### 9.2 ìë™ ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸
```bash
#!/bin/bash
# auto_recovery.sh

# ì¥ì•  ê°ì§€
if ! ./health_check.sh; then
    echo "ğŸ”„ ìë™ ë³µêµ¬ ì‹œì‘..."
    
    # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
    docker-compose restart web
    
    # 30ì´ˆ ëŒ€ê¸°
    sleep 30
    
    # ì¬í—¬ìŠ¤ì²´í¬
    if ./health_check.sh; then
        echo "âœ… ìë™ ë³µêµ¬ ì„±ê³µ"
    else
        echo "âŒ ìë™ ë³µêµ¬ ì‹¤íŒ¨ - ìˆ˜ë™ ê°œì… í•„ìš”"
        # ê´€ë¦¬ìì—ê²Œ ì•Œë¦¼
    fi
fi
```

## 10. ìš´ì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 10.1 ì¼ì¼ ì ê²€
- [ ] ì„œë¹„ìŠ¤ ê°€ìš©ì„± í™•ì¸
- [ ] ë¡œê·¸ íŒŒì¼ ê²€í† 
- [ ] ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰ í™•ì¸
- [ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
- [ ] ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìˆ˜ í™•ì¸

### 10.2 ì£¼ê°„ ì ê²€
- [ ] ë°±ì—… ìƒíƒœ í™•ì¸
- [ ] ë³´ì•ˆ ì—…ë°ì´íŠ¸ ì ìš©
- [ ] ì„±ëŠ¥ ì§€í‘œ ë¶„ì„
- [ ] ì—ëŸ¬ ë¡œê·¸ ë¶„ì„
- [ ] ì‚¬ìš©ì í”¼ë“œë°± ê²€í† 

### 10.3 ì›”ê°„ ì ê²€
- [ ] ì „ì²´ ì‹œìŠ¤í…œ ì ê²€
- [ ] ìš©ëŸ‰ ê³„íš ê²€í† 
- [ ] ë³´ì•ˆ ê°ì‚¬
- [ ] ì„±ëŠ¥ ìµœì í™”
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸

---

**ë¬¸ì„œ ë²„ì „**: v1.0  
**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-01-27  
**ì‘ì„±ì**: DevOps íŒ€ 